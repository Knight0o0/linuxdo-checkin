name: LinuxDo Daily Check-in

on:
  schedule:
    - cron: '0 */12 * * *'    # 每12小时执行一次（UTC 时间）
  workflow_dispatch:          # 支持手动触发

jobs:
  run_script:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Check Chrome version
        run: google-chrome --version

      - name: Install system dependencies (for chromium / DrissionPage)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libatk-bridge2.0-0 \
            libdrm2 \
            libxkbcommon0 \
            libgbm1 \
            libasound2 \
            fonts-liberation \
            libappindicator3-1 \
            xdg-utils \
            wget

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'   # 建议使用 3.11，更稳定且兼容性好

      - name: Install Python dependencies (升级 curl-cffi 和 DrissionPage)
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install --upgrade curl-cffi DrissionPage
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install \
              wcwidth==0.2.13 \
              tabulate==0.9.0 \
              loguru==0.7.2 \
              beautifulsoup4
          fi

      - name: Execute sign-in script
        env:
          LINUXDO_USERNAME:     ${{ secrets.LINUXDO_USERNAME }}
          LINUXDO_PASSWORD:     ${{ secrets.LINUXDO_PASSWORD }}
          BROWSE_ENABLED:       ${{ secrets.BROWSE_ENABLED }}
          GOTIFY_URL:           ${{ secrets.GOTIFY_URL }}
          GOTIFY_TOKEN:         ${{ secrets.GOTIFY_TOKEN }}
          SC3_PUSH_KEY:         ${{ secrets.SC3_PUSH_KEY }}
          WXPUSHER_APP_TOKEN:   ${{ secrets.WXPUSHER_APP_TOKEN }}
          WXPUSHER_TOPIC_IDS:   ${{ secrets.WXPUSHER_TOPIC_IDS }}
          TELEGRAM_TOKEN:       ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_USERID:      ${{ secrets.TELEGRAM_USERID }}
        run: python main.py

      # Telegram 成功通知
      - name: Send Telegram Success Notification
        if: success()
        env:
          TELEGRAM_TOKEN:   ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_USERID:  ${{ secrets.TELEGRAM_USERID }}
        run: |
          if [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_USERID" ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_USERID" \
              -d parse_mode=HTML \
              -d text="✅ <b>LinuxDo 签到成功</b> %0A时间: $(date '+%Y-%m-%d %H:%M UTC') %0A仓库: ${{ github.repository }}"
          fi

      # Telegram 失败通知
      - name: Send Telegram Failure Notification
        if: failure()
        env:
          TELEGRAM_TOKEN:   ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_USERID:  ${{ secrets.TELEGRAM_USERID }}
        run: |
          if [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_USERID" ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_USERID" \
              -d parse_mode=HTML \
              -d text="❌ <b>LinuxDo 签到失败</b> %0A时间: $(date '+%Y-%m-%d %H:%M UTC') %0A仓库: ${{ github.repository }} %0AJob URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

      # 清理旧运行记录
      - name: Delete old workflow runs
        if: always()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 10
          keep_minimum_runs: 6
